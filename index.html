<html>
<head>
    <title>Analytics</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
</head>
<body>
    <h1>
        Real-Time Visits</h1>
    <p>
        sample app demonstrating push notifications of visit data</p>
    
    <div>
      <b>Total visitors on <span id="date"></span></b>
      <h2 id="count"></h2>
    </div>
    
    <div id="messages"></div>
    
    <script type="text/javascript">
      var start;
      
      $(document).ready(function(){
        start = new Date();
        $('#date').html(start.getDate() + '/' + (start.getMonth()+1) + '/' + start.getFullYear());
      });      
      
      var source = new EventSource('http://localhost:1337');
      
      source.onopen = function (e) {
          console.log('new connection')
      };

      source.onmessage = function (e) {          
          var visits = JSON.parse(e.data);
          console.log(visits);
          
          $('#count').html(visits.length);

          for(var i=0;i<visits.length;i++) {
            $('#messages').append('<div>URL: ' + visits[i].url + '</div>');
            $('#messages').append('<div>IP: ' + visits[i].ipaddress + '</div>');
            $('#messages').append('<div>User Agent: ' + visits[i].useragent + '</div>');
            $('#messages').append('<div>Media Source: ' + visits[i].mediasource + '</div>');
            $('#messages').append('<div>Campaign: ' + visits[i].campaign + '</div>');
            $('#messages').append('<div>Referrer: ' + visits[i].referrer + '</div>');
            $('#messages').append('<div>UserId: ' + visits[i].userid + '</div>');
            $('#messages').append('<div>DateTime: ' + visits[i].createtime + '</div>');
            $('#messages').append('<br />');
          }
      };

      source.onerror = function (e) {
          if (e.readyState == EventSource.CLOSED) {
              //do something.  perhaps.
          }
      };
    
    </script>
</body>
</html>
